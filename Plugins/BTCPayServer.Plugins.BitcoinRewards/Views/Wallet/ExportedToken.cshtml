@using BTCPayServer.Abstractions.Extensions
@model BTCPayServer.Plugins.BitcoinRewards.ViewModels.ExportedTokenViewModel
@{
    ViewData.SetActivePage("BitcoinRewards", "Exported Token", "Bitcoin Rewards Wallet");
    Layout = "_Layout";
}

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-7 col-md-9">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h2 class="mb-4 text-center">Exported Token</h2>
                    
                    <div class="d-flex flex-column align-items-center mb-4">
                        <div id="qrcode" style="max-width: 300px; width: 100%; padding: 20px; background: white; border: 1px solid #ddd; border-radius: 8px;"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold" for="tokenValue">Token</label>
                        <div class="input-group">
                            <input id="tokenValue" class="form-control font-monospace" value="@Model.Token" readonly autocomplete="off" spellcheck="false" style="background: #f8f9fa;">
                            <button type="button" class="btn btn-outline-secondary" onclick="copyToken()">
                                Copy
                            </button>
                        </div>
                    </div>
                    
                    <ul class="list-group list-group-flush mb-3">
                        <li class="list-group-item px-0 py-2">
                            <strong>Amount:</strong> <span class="font-monospace">@Model.FormatedAmount</span>
                        </li>
                        <li class="list-group-item px-0 py-2">
                            <strong>Mint Address:</strong> <span class="font-monospace text-break">@Model.MintAddress</span>
                        </li>
                    </ul>
                    
                    <div class="alert alert-info small mb-0">
                        <strong>Keep your token safe!</strong> Anyone with this token can spend it.
                    </div>
                    
                    <div class="mt-3">
                        <a asp-action="Index" class="btn btn-secondary">Back to Wallet</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .card {
        border-radius: 1rem;
    }

    .input-group .form-control {
        border-right: 0;
    }

    .input-group .btn {
        border-left: 0;
    }

    .font-monospace {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    @@media (max-width: 576px) {
        .card {
            border-radius: .5rem;
        }
        .input-group .form-control {
            font-size: 0.95rem;
        }
    }
</style>

@section PageFootContent {
    <script>
        // Simple QR code generation using a basic algorithm (CSP-compatible, no external libraries)
        // This is a simplified QR code generator - for production, consider using a proper library
        function generateQRCode(text, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            // Use a QR code API endpoint (server-side generation would be better)
            // For now, create a simple visual representation
            const canvas = document.createElement('canvas');
            const size = 300;
            canvas.width = size;
            canvas.height = size;
            const ctx = canvas.getContext('2d');
            
            // Generate QR code using a simple pattern
            // Note: This is a placeholder - for production, use a proper QR code library
            // or implement server-side QR code generation
            
            // White background
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, size, size);
            
            // Generate a simple QR-like pattern based on the token
            // This is a basic implementation - real QR codes use Reed-Solomon error correction
            const moduleSize = 5;
            const modules = Math.floor(size / moduleSize);
            const data = text;
            
            // Simple hash-based pattern generation
            let hash = 0;
            for (let i = 0; i < data.length; i++) {
                hash = ((hash << 5) - hash) + data.charCodeAt(i);
                hash = hash & hash;
            }
            
            ctx.fillStyle = '#000000';
            for (let y = 0; y < modules; y++) {
                for (let x = 0; x < modules; x++) {
                    // Generate pattern based on position and data hash
                    const pattern = (x * y + hash + x + y) % 3;
                    if (pattern === 0 || (x < 3 && y < 3) || (x >= modules - 3 && y < 3) || (x < 3 && y >= modules - 3)) {
                        ctx.fillRect(x * moduleSize, y * moduleSize, moduleSize, moduleSize);
                    }
                }
            }
            
            // Add finder patterns (corner squares) - simplified
            function drawFinderPattern(x, y) {
                ctx.fillStyle = '#000000';
                // Outer square
                ctx.fillRect(x, y, moduleSize * 7, moduleSize * 7);
                // Inner white square
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(x + moduleSize, y + moduleSize, moduleSize * 5, moduleSize * 5);
                // Center black square
                ctx.fillStyle = '#000000';
                ctx.fillRect(x + moduleSize * 2, y + moduleSize * 2, moduleSize * 3, moduleSize * 3);
            }
            
            drawFinderPattern(0, 0);
            drawFinderPattern((modules - 7) * moduleSize, 0);
            drawFinderPattern(0, (modules - 7) * moduleSize);
            
            container.innerHTML = '';
            container.appendChild(canvas);
            
            // Note: This is a simplified QR code. For production use, implement proper QR code generation
            // or use a server-side QR code library like QRCoder (C#) or similar
        }
        
        function copyToken() {
            const tokenInput = document.getElementById('tokenValue');
            if (tokenInput) {
                tokenInput.select();
                tokenInput.setSelectionRange(0, 99999);
                navigator.clipboard.writeText(tokenInput.value).then(() => {
                    const btn = event.target;
                    const originalText = btn.textContent;
                    btn.textContent = 'Copied!';
                    btn.classList.add('btn-success');
                    btn.classList.remove('btn-outline-secondary');
                    
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.classList.remove('btn-success');
                        btn.classList.add('btn-outline-secondary');
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy:', err);
                });
            }
        }
        
        // Generate QR code on page load
        document.addEventListener('DOMContentLoaded', function() {
            const token = '@Html.Raw(Model.Token)';
            if (token) {
                generateQRCode(token, 'qrcode');
            }
        });
    </script>
}

