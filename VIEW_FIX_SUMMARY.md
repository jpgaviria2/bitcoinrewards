# Razor Views Fix Summary

## Problem
The plugin was failing with error: "The partial view 'BitcoinRewards/NavExtension' was not found."

Analysis showed:
- No .cshtml view files found in plugin package
- No Views/ directory in plugin package
- Views.dll assembly not being generated or included

## Solution Implemented

### 1. Razor SDK Configuration
Updated `.csproj` to ensure Razor views are properly compiled:

```xml
<PropertyGroup>
  <AddRazorSupportForMvc>true</AddRazorSupportForMvc>
  <RazorCompileOnBuild>true</RazorCompileOnBuild>
  <RazorCompileOnPublish>true</RazorCompileOnPublish>
  <EnableDefaultRazorCompileItems>true</EnableDefaultRazorCompileItems>
  <RazorGenerateAssemblyInfo>true</RazorGenerateAssemblyInfo>
  <GenerateEmbeddedFilesManifest>true</GenerateEmbeddedFilesManifest>
</PropertyGroup>
```

### 2. How BTCPay Server Loads Plugin Views

BTCPay Server uses the following mechanism (from `MvcPluginExtensions.cs`):

1. **Main Assembly**: Loads the plugin's main .btcpay (renamed .dll) file
2. **RelatedAssemblyAttribute**: Automatically discovers and loads `PluginName.Views.dll`
3. **EmbeddedFileProvider**: Uses `EmbeddedFileProvider` to access views from the Views assembly
4. **View Discovery**: Views are discovered via ApplicationParts

### 3. Expected Build Output

When building with `AddRazorSupportForMvc=true`, the Razor SDK should generate:

- `BTCPayServer.Plugins.BitcoinRewards.dll` → renamed to `.btcpay`
- `BTCPayServer.Plugins.BitcoinRewards.Views.dll` → **Must be included in plugin package**
- `BTCPayServer.Plugins.BitcoinRewards.Views.pdb` → Optional

### 4. Plugin Builder Package Requirements

The Plugin Builder must include:
1. ✅ Main plugin assembly: `BTCPayServer.Plugins.BitcoinRewards.btcpay`
2. ⚠️ **Views assembly**: `BTCPayServer.Plugins.BitcoinRewards.Views.dll` (must be included)
3. ✅ Dependencies: `.deps.json` file

### 5. View Path Registration

The plugin registers the view path as:
```csharp
applicationBuilder.AddUIExtension("header-nav", "BitcoinRewards/NavExtension");
```

This path corresponds to:
- View file: `Views/BitcoinRewards/NavExtension.cshtml`
- Compiled view: Discovered via `RelatedAssemblyAttribute` in `Views.dll`

## Verification Steps

After the next Plugin Builder build, verify:

1. **Check plugin package contents**:
   - Should contain `BTCPayServer.Plugins.BitcoinRewards.btcpay`
   - Should contain `BTCPayServer.Plugins.BitcoinRewards.Views.dll` ⚠️ **Critical**
   - Should contain `.deps.json`

2. **Check for RelatedAssemblyAttribute**:
   - The main assembly should have `[RelatedAssembly("BTCPayServer.Plugins.BitcoinRewards.Views")]` attribute
   - This is automatically generated by Razor SDK

3. **Test view loading**:
   - Install plugin in BTCPay Server
   - Navigate to store settings
   - Verify "Bitcoin Rewards" appears in navigation menu
   - No errors in logs about missing views

## If Views.dll Still Not Generated

If the Views.dll is still not being generated, it may indicate:

1. **Razor SDK Issue**: The SDK might not be creating the separate Views assembly
2. **Build Configuration**: May need to check if views are being excluded somehow
3. **Plugin Builder**: May need to ensure Plugin Builder includes all DLL files, not just .btcpay

## Next Steps

1. ✅ Configuration updated and pushed to GitHub
2. ⏳ Wait for Plugin Builder to rebuild
3. ⏳ Verify Views.dll is included in plugin package
4. ⏳ Test plugin installation and view loading

## References

- BTCPay Server Plugin System: `submodules/BTCPayServer/Plugins/Dotnet/MvcPluginExtensions.cs`
- View Discovery: Uses `RelatedAssemblyAttribute` and `EmbeddedFileProvider`
- Razor SDK: `Microsoft.NET.Sdk.Razor` with `AddRazorSupportForMvc=true`


